
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente de Suporte IA</title>
    <link rel="icon" href="https://uptecnology.com.br/wp-content/uploads/2025/02/LOGO-UP.png" type="image/png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'fundo': '#1a163a', 'sidebar': '#2c2854', 'card': '#38326b', 'principal': '#ff6b35',
              'texto-base': '#ffffff', 'texto-muted': '#a3a0c2', 'borda': '#4a4480',
            }
          }
        }
      }
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <script src="env.js"></script>
</head>
<body class="bg-fundo text-texto-base flex flex-col h-screen">

    <header class="bg-card p-4 flex justify-between items-center flex-shrink-0 shadow-lg">
        <div class="flex items-center gap-3">
            <i class="bi bi-robot text-3xl text-principal"></i>
            <div>
                <h1 class="font-bold text-xl">Agente de Suporte IA</h1>
                <p class="text-xs text-green-400">‚óè Online</p>
            </div>
        </div>
        <button id="agente-ia-limpar" class="bg-sidebar p-2 rounded-lg text-texto-muted hover:bg-fundo hover:text-white transition-colors" title="Limpar hist√≥rico da conversa">
            <i class="bi bi-trash3-fill text-xl"></i>
        </button>
    </header>

    <main id="agente-ia-corpo" class="flex-grow p-4 overflow-y-auto no-scrollbar space-y-4">
    </main>

    <footer class="p-4 border-t border-borda flex-shrink-0 bg-sidebar">
        <form id="agente-ia-form" class="flex items-center gap-2">
            <input type="text" id="agente-ia-input" placeholder="Pergunte sobre o sistema..." class="w-full bg-fundo p-3 rounded-lg border border-borda focus:ring-2 focus:ring-principal focus:outline-none" autocomplete="off">
            <button type="submit" class="w-14 h-14 bg-principal text-white rounded-lg flex-shrink-0 flex items-center justify-center text-xl"><i class="bi bi-send-fill"></i></button>
        </form>
    </footer>

    <!-- ‚úÖ SCRIPTS CARREGADOS COMO M√ìDULOS -->
    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/functions/api.js"></script>
    <script type="module">
        // ‚úÖ IMPORTANDO AS FUN√á√ïES QUE PRECISAMOS
        import { API_ENDPOINTS } from './js/config.js';
        // Importa a fun√ß√£o de enviar dados do api.js, mas renomeia para evitar conflito
        import { enviarParaAPI as enviarParaAPI_API } from './js/functions/api.js';

        const HISTORICO_CHAT_KEY = 'historicoChatAgenteIA';

        const corpoChat = document.getElementById('agente-ia-corpo');
        const form = document.getElementById('agente-ia-form');
        const input = document.getElementById('agente-ia-input');
        const btnLimpar = document.getElementById('agente-ia-limpar');

        let historicoMensagens = JSON.parse(localStorage.getItem(HISTORICO_CHAT_KEY)) || [];

        function salvarHistorico() {
            localStorage.setItem(HISTORICO_CHAT_KEY, JSON.stringify(historicoMensagens));
        }

        function carregarHistorico() {
            corpoChat.innerHTML = '';
            historicoMensagens.forEach(msg => adicionarMensagem(msg.texto, msg.autor, false));
        }

        function limparHistorico() {
            historicoMensagens = [];
            localStorage.removeItem(HISTORICO_CHAT_KEY);
            corpoChat.innerHTML = '';
            adicionarMensagem("Ol√°! Sou seu assistente virtual. Como posso te ajudar?", 'ia');
        }
        
        function adicionarMensagem(texto, autor, salvar = true) {
            if (!corpoChat) return;

            if ((autor === 'user' || autor === 'ia') && salvar) {
                historicoMensagens.push({ texto, autor });
                salvarHistorico();
            }

            const loadingMsg = corpoChat.querySelector('.loading-message');
            if (loadingMsg) loadingMsg.remove();

            const divMensagem = document.createElement('div');
            divMensagem.className = `flex items-end gap-2 max-w-[85%] ${autor === 'user' ? 'self-end' : 'self-start'}`;
            if (autor === 'loading') divMensagem.classList.add('loading-message');

            let conteudoHtml = '';
            if (autor === 'user') {
                conteudoHtml = `<div class="bg-principal p-3 rounded-lg rounded-br-none"><p></p></div>`;
            } else if (autor === 'ia') {
                conteudoHtml = `<div class="w-8 h-8 bg-card rounded-full flex items-center justify-center flex-shrink-0"><i class="bi bi-robot"></i></div><div class="bg-card p-3 rounded-lg rounded-bl-none"><p class="text-texto-muted"></p></div>`;
            } else if (autor === 'loading') {
                conteudoHtml = `<div class="w-8 h-8 bg-card rounded-full flex items-center justify-center flex-shrink-0"><i class="bi bi-robot"></i></div><div class="bg-card p-3 rounded-lg rounded-bl-none"><div class="flex items-center gap-2"><span class="w-2 h-2 bg-texto-muted rounded-full animate-bounce"></span><span class="w-2 h-2 bg-texto-muted rounded-full animate-bounce" style="animation-delay:0.2s"></span><span class="w-2 h-2 bg-texto-muted rounded-full animate-bounce" style="animation-delay:0.4s"></span></div></div>`;
            }
            
            divMensagem.innerHTML = conteudoHtml;
            
            const p = divMensagem.querySelector('p');
            if (p) {
                if (autor === 'ia') {
                    p.innerHTML = texto.replace(/\n/g, '<br>'); // Garante que quebras de linha da IA sejam renderizadas
                } else {
                    p.textContent = texto;
                }
            }

            corpoChat.appendChild(divMensagem);
            corpoChat.scrollTop = corpoChat.scrollHeight;
        }

        async function enviarPerguntaParaIA(pergunta) {
            adicionarMensagem(pergunta, 'user');
            adicionarMensagem('', 'loading', false);

            try {
                // ‚úÖ CHAMADA SEGURA PARA O PROXY, USANDO NOSSA FUN√á√ÉO PADR√ÉO
                const data = await enviarParaAPI_API(API_ENDPOINTS.call_ia_proxy, { pergunta: pergunta });

                const respostaIA = data[0]?.output || data.resposta || "N√£o entendi, pode repetir?";
                adicionarMensagem(respostaIA, 'ia');

            } catch (error) {
                console.error('Erro ao chamar o Agente IA via Proxy:', error);
                adicionarMensagem("Tive um probleminha de conex√£o. üò• Tente de novo, por favor.", 'ia');
            }
        }
        
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const pergunta = input.value.trim();
            if (pergunta) {
                enviarPerguntaParaIA(pergunta);
                input.value = '';
            }
        });

        btnLimpar.addEventListener('click', limparHistorico);
        
        if (historicoMensagens.length === 0) {
            adicionarMensagem("Ol√°! Sou seu assistente virtual. Como posso te ajudar?", 'ia');
        } else {
            carregarHistorico();
        }
    </script>
</body>
</html>